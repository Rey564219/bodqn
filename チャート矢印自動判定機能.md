# 🎯 チャート矢印による自動判定機能

## 📋 新機能の概要

チャート上の矢印を自動解析して、グレーの矢印（負け）が多い場合にトレードを自動停止する機能を実装しました。

---

## 🎨 矢印の色による判定ルール

### 勝ち判定 ✅
- **赤矢印**: 下方向の勝ち
- **緑矢印**: 上方向の勝ち

### 負け判定 ❌  
- **グレー矢印**: 負け（上下どちらでも）

### スキップ対象
- **黒い矢印**: 判定から除外

---

## ⚙️ 自動ブロック設定

```python
RECENT_CHECK_COUNT = 10      # 右から数えて何個の矢印を見るか
RECENT_LOSS_THRESHOLD = 6    # そのうち何個以上がグレーならブロックするか  
RECENT_BLOCK_SECONDS = 120   # ブロック時間（2分）
```

### ブロック条件
**直近10個の矢印のうち、グレー矢印が6個以上** = 2分間トレード停止

---

## 🔄 自動動作の流れ

### 1. 定期チェック（10秒ごと）
```
[🎯 CHART] チャート矢印の解析を開始...
[CHART] チャート矢印を12個検出
[✅ ARROW #1] win (x:850.1) fill:red stroke:
[❌ ARROW #2] loss (x:820.3) fill:gray stroke:
[✅ ARROW #3] win (x:790.5) fill:green stroke:
```

### 2. 直近10個の評価
```
[🎯 ARROW EVAL] 直近10個の矢印評価:
  - 勝ち（赤・緑）: 4個
  - 負け（グレー）: 6個  
  - 配列: 🔴 ⚪ 🔴 ⚪ ⚪ 🔴 ⚪ ⚪ ⚪ 🔴
```

### 3. ブロック判定
```
[🚫 PAUSE] グレー矢印が6個/10個 (>=6) => トレードを120秒間停止
[⏰ PAUSE] 停止終了予定: 18:32:15
```

### 4. エントリーブロック
```
[⏸️ PAUSE] High - チャート矢印(グレー矢印多数)によりトレード停止中 (残り85秒, 18:32:15まで)
```

---

## 📊 リアルタイム状態表示

### 30秒ごとの状態確認
```
[📊 STATUS] システム状態
  🚫 チャート矢印ブロック: 残り45秒 (18:32:15まで)
  📋 手動負け履歴: なし
```

### ブロック解除時
```
[📊 STATUS] システム状態  
  ✅ チャート矢印ブロック: なし
  📋 手動負け履歴: なし
```

---

## 🎯 技術的な実装

### JavaScript によるSVG解析
```javascript
// SVG要素内の矢印を色で判定
const paths = svg.querySelectorAll('path, circle, polygon');
paths.forEach(path => {
    const fill = style.fill || path.getAttribute('fill') || '';
    
    if (fill.includes('gray') || fill.includes('grey')) {
        result = 'loss';  // グレー = 負け
    } else if (fill.includes('red')) {
        result = 'win';   // 赤 = 勝ち  
    } else if (fill.includes('green')) {
        result = 'win';   // 緑 = 勝ち
    }
});
```

### 座標による並び順
- X座標で右から左へソート
- 右側が最新（時系列順）

---

## 💡 使用例

### 正常な状況
```
[🎯 ARROW EVAL] 直近10個の矢印評価:
  - 勝ち（赤・緑）: 7個
  - 負け（グレー）: 3個
  - 配列: 🔴 🔴 ⚪ 🔴 🔴 ⚪ 🔴 🔴 🔴 ⚪
[✅ CONTINUE] グレー矢印が3個/10個 (<6) => 取引継続可能
```

### ブロック発動
```
[🎯 ARROW EVAL] 直近10個の矢印評価:
  - 勝ち（赤・緑）: 3個  
  - 負け（グレー）: 7個
  - 配列: ⚪ ⚪ 🔴 ⚪ ⚪ ⚪ 🔴 ⚪ 🔴 ⚪
[🚫 PAUSE] グレー矢印が7個/10個 (>=6) => トレードを120秒間停止
```

---

## 🔧 カスタマイズ

### 閾値を変更したい場合
```python
RECENT_CHECK_COUNT = 15      # 15個の矢印を確認
RECENT_LOSS_THRESHOLD = 8    # 8個以上でブロック  
RECENT_BLOCK_SECONDS = 180   # 3分間停止
```

### チェック間隔を変更
```python
# メインループ内（現在は10秒ごと）
if current_time.second % 5 < TICK_INTERVAL_SECONDS:  # 5秒ごとに変更
```

---

## ⚠️ 注意事項

1. **サイト構造依存**: チャートのSVG構造が変更されると調整が必要
2. **色の判定**: CSS や fill 属性の色指定方法に依存  
3. **パフォーマンス**: 10秒ごとのDOM解析がシステム負荷を与える可能性
4. **従来機能**: 手動記録による連敗フィルターも並行動作

---

## 🚀 メリット

1. **完全自動**: 手動記録が不要
2. **リアルタイム**: 10秒ごとの自動判定
3. **視覚的**: チャート上の矢印を直接解析
4. **正確**: 実際の勝敗結果を反映
5. **柔軟**: 設定値の調整が容易

---

## 📈 従来機能との併用

この新機能は既存の手動記録システムと併用できます：

- **自動**: チャート矢印解析による自動ブロック
- **手動**: `add_loss_to_history()` による手動記録
- **両方**: それぞれ独立してブロック判定

最も厳しい条件が適用され、トレード安全性が向上します。