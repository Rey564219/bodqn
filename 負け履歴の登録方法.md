# 📋 負け履歴の登録方法

## 🎯 直近の負けが検出できない場合の対処法

取引結果の自動検出が機能しない場合は、以下の方法で**手動で負け履歴を登録**してください。

---

## ✅ 方法1: 最も簡単（推奨）

**直近のエントリーが負けた場合:**

```python
add_last_trade_loss(loss_history, pending_trades)
```

このコマンド1つで、最後にエントリーした取引を負けとして記録します。

### 使い方
1. BOTが取引をエントリー
2. 結果を確認（負けだった）
3. Pythonコンソールで上記コマンドを実行
4. 自動的に負け履歴に追加される

---

## 📝 方法2: 個別に記録

**High負けを記録:**
```python
add_loss_to_history(loss_history, 'High', 150.123)
```

**Low負けを記録:**
```python
add_loss_to_history(loss_history, 'Low', 150.456)
```

### 使い方
1. 取引結果を確認
2. エントリー価格をメモ（例: 150.123）
3. 上記コマンドで記録

---

## ⏰ 方法3: 過去の取引を記録

**2分前の取引を記録する場合:**
```python
from datetime import datetime, timedelta
past_time = datetime.now() - timedelta(minutes=2)
add_loss_to_history(loss_history, 'High', 150.123, past_time)
```

### 使い方
1. 過去の負け取引を思い出す
2. 何分前かを計算
3. 上記のように時刻を指定して記録

---

## 🔍 現在の状態を確認

**待機中の取引を確認:**
```python
print(f"待機中: {len(pending_trades)}件")
for t, a, p in pending_trades:
    print(f"  {a} @ {p:.3f} at {t.strftime('%H:%M:%S')}")
```

**負け履歴を確認:**
```python
print(f"負け履歴: {len(loss_history)}件")
for t, a, r, p in loss_history:
    print(f"  {a} @ {p:.3f} at {t.strftime('%H:%M:%S')}")
```

---

## 📊 自動表示される情報

プログラムは自動的に以下の情報を表示します：

### エントリー時
```
[ENTRY] High at 14:35:21 price=150.123 Q値: 0.5678
[INFO] 取引を待ちリストに追加（60秒後に結果確認）
```

### 60秒後の結果確認時
```
============================================================
[⏰ RESULT CHECK] 14:35:21のHigh取引結果確認
[💰 ENTRY] エントリー価格: 150.123
============================================================

[⚠️ WARNING] 自動検出できませんでした
[📋 手動記録方法]
  負けた場合:
    add_loss_to_history(loss_history, 'High', 150.123)
```

### 30秒ごとの履歴表示
```
[📊 LOSS HISTORY] 直近5分間の負け履歴
  - High負け: 2回
  - Low負け: 1回
  - 最新の負け:
    High @ 150.123 (2分前)
    Low @ 150.456 (4分前)
```

---

## 🚫 ブロック機能の動作

負けが3回連続すると自動的にブロックされます：

```
[🚫 BLOCK] High判定ブロック中 - 残り145秒（14:38:21まで）
```

3分後、トレンドが変わっていればブロック解除：

```
[✓ UNBLOCK] トレンド転換（上昇）を検出 - High判定を許可
```

---

## 💡 実践例

### 例1: 連続で負けている場合

```
# 1回目の負け
add_loss_to_history(loss_history, 'High', 150.123)
→ [📊 LOSS] 直近負け - High:1回, Low:0回

# 2回目の負け
add_loss_to_history(loss_history, 'High', 150.234)
→ [📊 LOSS] 直近負け - High:2回, Low:0回

# 3回目の負け
add_loss_to_history(loss_history, 'High', 150.345)
→ [📊 LOSS] 直近負け - High:3回, Low:0回
→ [🚫 BLOCK] High判定ブロック中 - 残り180秒
```

### 例2: 簡単コマンドを使う場合

```
# BOTがHighエントリー → 負けた
add_last_trade_loss(loss_history, pending_trades)

# BOTがHighエントリー → 負けた
add_last_trade_loss(loss_history, pending_trades)

# BOTがHighエントリー → 負けた
add_last_trade_loss(loss_history, pending_trades)
→ 自動的に3分間Highブロック
```

---

## ⚠️ 注意事項

1. **大文字小文字に注意**: `'High'` と `'Low'` は必ず最初だけ大文字
2. **価格は小数点形式**: `150.123` のように記述
3. **勝った取引は記録不要**: 負けだけを記録
4. **古い履歴は自動削除**: 10分以上前の履歴は自動的にクリーンアップ

---

## 🎓 まとめ

- **最も簡単**: `add_last_trade_loss(loss_history, pending_trades)`
- **個別記録**: `add_loss_to_history(loss_history, 'High', 150.123)`
- **3回連続**: 自動的に3分間ブロック
- **状態確認**: 30秒ごとに自動表示

この方法で確実に負け履歴を記録し、連敗フィルターを活用できます！
